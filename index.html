<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Cairo,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;min-height:100vh}
.container{max-width:1000px;margin:0 auto}
.header{background:#fff;padding:24px;border-radius:16px;margin-bottom:20px;box-shadow:0 4px 20px rgba(0,0,0,0.15);border:3px solid #4338ca;position:relative;padding-left:200px}
.logo{position:absolute;top:50%;left:20px;transform:translateY(-50%);width:160px;height:auto;border-radius:12px}
.header h1{font-size:24px;color:#4338ca;text-align:center;margin-bottom:12px}
.stats{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:16px}
.status{text-align:center;padding:8px;background:#dbeafe;color:#1e40af;border-radius:8px;font-size:12px;font-weight:700;margin-top:12px}
.stat{background:linear-gradient(135deg,#4338ca,#6366f1);color:#fff;padding:12px 20px;border-radius:10px;font-weight:700;font-size:14px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
.card{background:#fff;padding:24px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.15);border:3px solid #4338ca}
.title{font-size:18px;font-weight:800;color:#4338ca;margin-bottom:20px;padding-bottom:12px;border-bottom:3px solid #e0e7ff}
.group{margin-bottom:16px}
.group label{display:block;font-size:14px;font-weight:700;color:#1f2937;margin-bottom:8px}
.group input,.group select,.group textarea{width:100%;padding:12px;border:2px solid #9ca3af;border-radius:10px;font-size:15px;font-weight:600;font-family:Cairo,sans-serif}
.group textarea{min-height:90px;resize:vertical}
.row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.btn{width:100%;padding:12px 20px;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;font-family:Cairo,sans-serif;transition:transform 0.2s}
.btn:hover{transform:translateY(-2px)}
.btn-primary{background:linear-gradient(135deg,#4338ca,#6366f1);color:#fff}
.btn-success{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
.btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
.btn-warning{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
.btn-outline{background:#fff;color:#4338ca;border:2px solid #4338ca}
.btns{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:16px}
.search{display:flex;gap:10px;margin-bottom:16px}
.search input{flex:1;padding:12px;border:2px solid #9ca3af;border-radius:10px;font-size:15px;font-weight:600}
.results{margin-top:20px;padding:16px;background:#f9fafb;border-radius:10px;border:2px solid #d1d5db;max-height:400px;overflow-y:auto}
.item{background:#fff;padding:14px;margin-bottom:10px;border-radius:8px;border:2px solid #e5e7eb;cursor:pointer;transition:all 0.2s}
.item:hover{border-color:#4338ca;transform:translateX(-4px);box-shadow:0 2px 10px rgba(67,56,202,0.2)}
.name{font-size:16px;font-weight:700;color:#1f2937;margin-bottom:8px}
.tags{display:flex;gap:8px;flex-wrap:wrap;font-size:13px}
.tag{padding:4px 12px;border-radius:6px;font-weight:600}
.green{background:#d1fae5;color:#065f46}
.red{background:#fee2e2;color:#991b1b}
.orange{background:#fef3c7;color:#92400e}
.blue{background:#e0e7ff;color:#3730a3}
.empty{text-align:center;padding:40px;color:#6b7280;font-weight:600}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;padding:20px}
.box{background:#fff;border-radius:16px;padding:28px;max-width:500px;width:100%;border:3px solid #4338ca}
.head{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:3px solid #e0e7ff}
.head h3{font-size:20px;font-weight:800;color:#4338ca}
.close{background:#ef4444;color:#fff;border:none;width:36px;height:36px;border-radius:50%;font-size:20px;cursor:pointer;transition:transform 0.2s}
.close:hover{transform:rotate(90deg)}
.alert{padding:16px;border-radius:10px;font-size:15px;font-weight:600;line-height:1.7}
.success{background:#d1fae5;color:#065f46;border-right:4px solid #10b981}
.error{background:#fee2e2;color:#991b1b;border-right:4px solid #ef4444}
.warning{background:#fef3c7;color:#92400e;border-right:4px solid #f59e0b}
.info{background:#dbeafe;color:#1e40af;border-right:4px solid #3b82f6}
.sync-card{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;padding:20px;border-radius:12px;margin-bottom:20px;display:none}
.code{background:rgba(255,255,255,0.2);padding:12px;border-radius:8px;font-family:monospace;font-size:12px;word-break:break-all;margin:10px 0;cursor:pointer;max-height:100px;overflow-y:auto}
.opts label{display:block;padding:12px;border:2px solid #d1d5db;border-radius:8px;margin-bottom:8px;cursor:pointer;font-weight:600;transition:all 0.2s}
.opts label:hover{border-color:#4338ca;background:#f0f4ff}
@media(max-width:768px){
body{padding:10px}
.header{padding-left:24px;padding-top:120px}
.logo{width:140px;top:15px;left:50%;transform:translateX(-50%)}
.grid{grid-template-columns:1fr}
.row{grid-template-columns:1fr}
.btns{grid-template-columns:1fr}
.search{flex-direction:column}
}
</style>
</head>
<body>
<div class="container">
<div class="sync-card" id="syncCard">
<h3 style="margin-bottom:12px">ğŸ”„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h3>
<div style="font-size:14px;margin-bottom:10px">Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯:</div>
<div class="code" id="code" onclick="copyCode()">Ø§Ù†Ù‚Ø± Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯</div>
<div style="display:flex;gap:10px">
<button class="btn btn-success" onclick="makeCode()" style="flex:1">âœ¨ Ø¥Ù†Ø´Ø§Ø¡</button>
<button class="btn btn-outline" onclick="loadCode()" style="flex:1;color:#fff;border-color:#fff">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
</div>
</div>

<div class="header">
<img src="https://i.postimg.cc/7ZrgS8qs/lwjw-bnfsjy-bsyt-%CA%BFn-stwdyw-3.png" class="logo" alt="Logo">
<h1>ğŸ“‹ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</h1>
<div class="stats">
<div class="stat">ğŸ“Š Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total">0</span></div>
<div class="stat">âœ… Ù…ØªÙˆÙØ±: <span id="avail">0</span></div>
<div class="stat">âŒ Ù†Ø§Ù‚Øµ: <span id="miss">0</span></div>
</div>
<div class="status" id="status">ğŸ’¾ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…ÙØ¹Ù„</div>
</div>

<div class="grid">
<div class="card">
<div class="title">ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¹Ø±Ø¶</div>
<div class="search">
<input type="text" id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù…...">
<button class="btn btn-primary" onclick="search()" style="width:auto">ğŸ” Ø¨Ø­Ø«</button>
</div>
<div class="btns">
<button class="btn btn-outline" onclick="showAll()">ğŸ“‘ Ø§Ù„ÙƒÙ„</button>
<button class="btn btn-outline" onclick="showMiss()">âš ï¸ Ø§Ù„Ù†Ø§Ù‚Øµ</button>
<button class="btn btn-primary" onclick="toggleSync()">ğŸ”„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
</div>
<div class="results" id="results">
<div class="empty">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ ğŸ‘†</div>
</div>
</div>

<div class="card">
<div class="title">âœï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
<div class="group">
<label>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…</label>
<input type="text" id="name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…">
</div>
<div class="row">
<div class="group">
<label>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
<input type="number" id="qty" value="0" min="0">
</div>
<div class="group">
<label>âš§ï¸ Ø§Ù„Ø¬Ù†Ø³</label>
<select id="gender">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³</option>
<option value="Ø°ÙƒØ±">ğŸ‘¦ Ø°ÙƒØ±</option>
<option value="Ø£Ù†Ø«Ù‰">ğŸ‘§ Ø£Ù†Ø«Ù‰</option>
</select>
</div>
</div>
<div class="group">
<label>ğŸ¨ Ø§Ù„Ù„ÙˆÙ†</label>
<input type="text" id="color" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù„ÙˆÙ†">
</div>
<div class="group">
<label>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
<textarea id="note" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
</div>
<div class="btns">
<button class="btn btn-success" onclick="add()">â• Ø¥Ø¶Ø§ÙØ©</button>
<button class="btn btn-primary" onclick="update()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
<button class="btn btn-danger" onclick="del()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
<button class="btn btn-outline" onclick="clearForm()">ğŸ§¹ Ù…Ø³Ø­</button>
</div>
</div>

<div class="card">
<div class="title">ğŸ’° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹</div>
<div class="group">
<label>ğŸ·ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
<input type="text" id="sname" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
</div>
<div class="group">
<label>ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
<input type="number" id="sqty" value="1" min="1">
</div>
<div class="btns">
<button class="btn btn-warning" onclick="sell()">ğŸ’¸ Ø¨ÙŠØ¹</button>
<button class="btn btn-outline" onclick="check()">ğŸ” ÙØ­Øµ</button>
</div>
</div>

<div class="card">
<div class="title">ğŸ“¤ Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©</div>
<div class="btns">
<button class="btn btn-success" onclick="backup()">ğŸ’¾ ØªØ­Ù…ÙŠÙ„</button>
<button class="btn btn-primary" onclick="restore()">ğŸ“¥ Ø§Ø³ØªØ±Ø¯Ø§Ø¯</button>
<button class="btn btn-outline" onclick="openPrint()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
<button class="btn btn-outline" onclick="exportMiss()">ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø§Ù‚Øµ</button>
</div>
<input type="file" id="file" accept=".csv" style="display:none">
</div>
</div>
</div>

<div id="modal" class="modal">
<div class="box">
<div class="head">
<h3 id="mtitle">Ø±Ø³Ø§Ù„Ø©</h3>
<button class="close" onclick="closeModal()">Ã—</button>
</div>
<div id="mbody"></div>
</div>
</div>

<div id="printModal" class="modal">
<div class="box">
<div class="head">
<h3>ğŸ–¨ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</h3>
<button class="close" onclick="closePrint()">Ã—</button>
</div>
<div class="opts">
<div style="font-weight:700;margin-bottom:12px">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³:</div>
<label><input type="radio" name="pg" value="all" checked> ğŸ‘¥ Ø§Ù„ÙƒÙ„</label>
<label><input type="radio" name="pg" value="Ø°ÙƒØ±"> ğŸ‘¦ Ø°ÙƒÙˆØ± ÙÙ‚Ø·</label>
<label><input type="radio" name="pg" value="Ø£Ù†Ø«Ù‰"> ğŸ‘§ Ø¥Ù†Ø§Ø« ÙÙ‚Ø·</label>
<div style="font-weight:700;margin:16px 0 12px">Ù†ÙˆØ¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</div>
<label><input type="radio" name="pt" value="all" checked> ğŸ“‘ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</label>
<label><input type="radio" name="pt" value="zero"> âŒ Ø§Ù„Ù†Ø§Ù‚Øµ (ÙƒÙ…ÙŠØ© = 0)</label>
<label><input type="radio" name="pt" value="one"> âš ï¸ Ù†Ø§ÙØ° Ù‚Ø±ÙŠØ¨Ø§ (ÙƒÙ…ÙŠØ© = 1)</label>
</div>
<button class="btn btn-primary" onclick="printRecords()" style="width:100%;margin-top:16px">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
</div>
</div>

<script>
var db = [];
var KEY = 'names_v5';

function init() {
  try {
    var s = localStorage.getItem(KEY);
    db = s ? JSON.parse(s) : [];
  } catch (e) {
    db = [];
  }
  if (db.length === 0) {
    db = [
      {name: 'Ø®Ø§Ù„Ø¯', gender: 'Ø°ÙƒØ±', qty: 25, color: 'Ø£Ø²Ø±Ù‚', note: 'Ù…Ù‚Ø§Ø³ ØµØºÙŠØ±'},
      {name: 'Ø®Ø§Ù„Ø¯Ø©', gender: 'Ø£Ù†Ø«Ù‰', qty: 10, color: 'Ø£Ø­Ù…Ø±', note: 'Ù…Ø®ØµØµØ©'},
      {name: 'Ø£Ø­Ù…Ø¯', gender: 'Ø°ÙƒØ±', qty: 0, color: 'Ø£Ø®Ø¶Ø±', note: 'Ù†Ø§Ù‚Øµ'},
      {name: 'ÙØ§Ø·Ù…Ø©', gender: 'Ø£Ù†Ø«Ù‰', qty: 1, color: 'ÙˆØ±Ø¯ÙŠ', note: 'Ù†Ø§ÙØ° Ù‚Ø±ÙŠØ¨Ø§'}
    ];
    save();
  }
  stats();
}

function save() {
  try {
    localStorage.setItem(KEY, JSON.stringify(db));
    stats();
    document.getElementById('status').textContent = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸';
    setTimeout(function() {
      document.getElementById('status').textContent = 'ğŸ’¾ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…ÙØ¹Ù„';
    }, 2000);
  } catch (e) {
    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸');
  }
}

function stats() {
  document.getElementById('total').textContent = db.length;
  var a = 0, m = 0;
  for (var i = 0; i < db.length; i++) {
    if (db[i].qty > 0) a++; else m++;
  }
  document.getElementById('avail').textContent = a;
  document.getElementById('miss').textContent = m;
}

function makeCode() {
  var c = btoa(unescape(encodeURIComponent(JSON.stringify(db))));
  document.getElementById('code').textContent = c;
  document.getElementById('syncCard').style.display = 'block';
  msg('âœ… ØªÙ…', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

function copyCode() {
  var c = document.getElementById('code').textContent;
  if (c === 'Ø§Ù†Ù‚Ø± Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯') return makeCode();
  var t = document.createElement('textarea');
  t.value = c;
  t.style.position = 'fixed';
  t.style.opacity = '0';
  document.body.appendChild(t);
  t.select();
  try {
    document.execCommand('copy');
    msg('âœ… ØªÙ…', 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
  } catch (e) {
    prompt('Ø§Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯:', c);
  }
  document.body.removeChild(t);
}

function loadCode() {
  var c = prompt('Ø§Ù„ØµÙ‚ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:');
  if (!c) return;
  try {
    var imp = JSON.parse(decodeURIComponent(escape(atob(c))));
    if (!Array.isArray(imp)) throw new Error('Invalid');
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ' + imp.length + ' Ø³Ø¬Ù„ØŸ')) {
      db = imp;
      save();
      show(db, 'âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
      msg('âœ… Ù†Ø¬Ø­', 'ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }
  } catch (e) {
    msg('âŒ Ø®Ø·Ø£', 'Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù', 'error');
  }
}

function show(items, title) {
  var r = document.getElementById('results');
  if (items.length === 0) {
    r.innerHTML = '<div class="empty">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
    return;
  }
  var h = '';
  if (title) h += '<div style="font-weight:800;color:#4338ca;margin-bottom:12px;font-size:16px">' + title + '</div>';
  for (var i = 0; i < items.length; i++) {
    var it = items[i];
    var gIcon = it.gender === 'Ø°ÙƒØ±' ? 'ğŸ‘¦' : 'ğŸ‘§';
    var tag = it.qty === 0 ? '<span class="tag red">âŒ Ù†Ø§Ù‚Øµ</span>' : it.qty === 1 ? '<span class="tag orange">âš ï¸ Ù‚Ø·Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©</span>' : '<span class="tag green">âœ… ' + it.qty + '</span>';
    h += '<div class="item" onclick="fill(\'' + it.name.replace(/'/g, "\\'") + '\')">';
    h += '<div class="name">' + (i + 1) + '. ' + it.name + '</div>';
    h += '<div class="tags">' + tag;
    h += '<span class="tag blue">' + gIcon + ' ' + (it.gender || '-') + '</span>';
    if (it.color) h += '<span class="tag blue">ğŸ¨ ' + it.color + '</span>';
    if (it.note) h += '<span class="tag blue">ğŸ“ ' + it.note + '</span>';
    h += '</div></div>';
  }
  r.innerHTML = h;
}

function fill(n) {
  for (var i = 0; i < db.length; i++) {
    if (db[i].name === n) {
      document.getElementById('name').value = db[i].name;
      document.getElementById('qty').value = db[i].qty;
      document.getElementById('gender').value = db[i].gender || '';
      document.getElementById('color').value = db[i].color || '';
      document.getElementById('note').value = db[i].note || '';
      msg('âœ… ØªÙ…', 'ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
      break;
    }
  }
}

function msg(t, m, type) {
  document.getElementById('mtitle').textContent = t;
  var cls = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
  document.getElementById('mbody').innerHTML = '<div class="alert ' + cls + '">' + m + '</div>';
  document.getElementById('modal').style.display = 'flex';
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

function toggleSync() {
  var c = document.getElementById('syncCard');
  c.style.display = c.style.display === 'none' || c.style.display === '' ? 'block' : 'none';
}

function search() {
  var q = document.getElementById('q').value.trim().toLowerCase();
  if (!q) return msg('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø¨Ø­Ø«', 'warning');
  var res = [];
  for (var i = 0; i < db.length; i++) {
    if (db[i].name.toLowerCase().indexOf(q) !== -1) res.push(db[i]);
  }
  show(res, 'ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (' + res.length + ')');
}

function showAll() {
  show(db, 'ğŸ“‘ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (' + db.length + ')');
}

function showMiss() {
  var m = [];
  for (var i = 0; i < db.length; i++) {
    if (db[i].qty === 0) m.push(db[i]);
  }
  show(m, 'âŒ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ© (' + m.length + ')');
}

function add() {
  var n = document.getElementById('name').value.trim();
  var g = document.getElementById('gender').value;
  if (!n) return msg('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…', 'warning');
  if (!g) return msg('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³', 'warning');
  for (var i = 0; i < db.length; i++) {
    if (db[i].name.toLowerCase() === n.toLowerCase()) return msg('âš ï¸ Ù…ÙˆØ¬ÙˆØ¯', 'Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'warning');
  }
  db.push({
    name: n,
    qty: parseInt(document.getElementById('qty').value) || 0,
    gender: g,
    color: document.getElementById('color').value.trim(),
    note: document.getElementById('note').value.trim()
  });
  save();
  msg('âœ… Ù†Ø¬Ø­', 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
  clearForm();
  showAll();
}

function update() {
  var n = document.getElementById('name').value.trim();
  if (!n) return msg('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…', 'warning');
  var idx = -1;
  for (var i = 0; i < db.length; i++) {
    if (db[i].name.toLowerCase() === n.toLowerCase()) {
      idx = i;
      break;
    }
  }
  if (idx === -1) return msg('âŒ Ø®Ø·Ø£', 'Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
  var g = document.getElementById('gender').value;
  if (!g) return msg('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³', 'warning');
  db[idx] = {
    name: n,
    qty: parseInt(document.getElementById('qty').value) || 0,
    gender: g,
    color: document.getElementById('color').value.trim(),
    note: document.getElementById('note').value.trim()
  };
  save();
  msg('âœ… Ù†Ø¬Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
  showAll();
}

function del() {
  var n = document.getElementById('name').value.trim();
  if (!n) return msg('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…', 'warning');
  var idx = -1;
  for (var i = 0; i < db.length; i++) {
    if (db[i].name.toLowerCase() === n.toLowerCase()) {
      idx = i;
      break;
    }
  }
  if (idx === -1) return msg('âŒ Ø®Ø·Ø£', 'Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
  if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
  db.splice(idx, 1);
  save();
  msg('âœ… Ù†Ø¬Ø­', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
  clearForm();
  showAll();
}

function clearForm() {
  document.getElementById('name').value = '';
  document.getElementById('qty').value = '0';
  document.getElementById('gender').value = '';
  document.getElementById('color').value = '';
  document.getElementById('note').value = '';
}

function check() {
  var n = document.getElementById('sname').value.trim();
  if (!n) return msg('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬', 'warning');
  var it = null;
  for (var i = 0; i < db.length; i++) {
    if (db[i].name.toLowerCase() === n.toLowerCase()) {
      it = db[i];
      break;
    }
  }
  if (!it) return msg('âŒ Ø®Ø·Ø£', 'Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
  var gIcon = it.gender === 'Ø°ÙƒØ±' ? 'ğŸ‘¦' : 'ğŸ‘§';
  var st = it.qty === 0 ? 'âŒ ØºÙŠØ± Ù…ØªÙˆÙØ±' : it.qty === 1 ? 'âš ï¸ Ù†Ø§ÙØ° Ù‚Ø±ÙŠØ¨Ø§: Ù‚Ø·Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©' : 'âœ… Ù…ØªÙˆÙØ±: ' + it.qty + ' Ù‚Ø·Ø¹Ø©';
  msg('ğŸ“Š Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', '<strong>' + gIcon + ' ' + it.name + '</strong><br><br>' + st, 'info');
}

function sell() {
  var n = document.getElementById('sname').value.trim();
  var q = parseInt(document.getElementById('sqty').value) || 0;
  if (!n) return msg('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬', 'warning');
  if (q <= 0) return msg('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©', 'warning');
  var idx = -1;
  for (var i = 0; i < db.length; i++) {
    if (db[i].name.toLowerCase() === n.toLowerCase()) {
      idx = i;
      break;
    }
  }
  if (idx === -1) return msg('âŒ Ø®Ø·Ø£', 'Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
  if (db[idx].qty < q) return msg('âŒ Ø®Ø·Ø£', 'Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© ØºÙŠØ± ÙƒØ§ÙÙŠØ©<br>Ø§Ù„Ù…ØªÙˆÙØ±: ' + db[idx].qty + ' Ù‚Ø·Ø¹Ø©', 'error');
  if (!confirm('ğŸ’¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨ÙŠØ¹ ' + q + ' Ù‚Ø·Ø¹Ø© Ù…Ù† ' + db[idx].name + 'ØŸ')) return;
  db[idx].qty -= q;
  save();
  var m = 'âœ… ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­<br><br>ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©: ' + q + ' Ù‚Ø·Ø¹Ø©<br>ğŸ“Š Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ' + db[idx].qty + ' Ù‚Ø·Ø¹Ø©';
  if (db[idx].qty === 0) m += '<br><br>âŒ ØªØ­Ø°ÙŠØ±: Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù†ÙØ° ØªÙ…Ø§Ù…Ø§Ù‹!';
  else if (db[idx].qty === 1) m += '<br><br>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù…ØªØ¨Ù‚ÙŠ Ù‚Ø·Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·!';
  msg('ğŸ’° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹', m, 'success');
  document.getElementById('sname').value = '';
  document.getElementById('sqty').value = '1';
}

function backup() {
  if (db.length === 0) return msg('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù…ÙŠÙ„', 'warning');
  var csv = 'Ø§Ù„Ø§Ø³Ù…,Ø§Ù„ÙƒÙ…ÙŠØ©,Ø§Ù„Ø¬Ù†Ø³,Ø§Ù„Ù„ÙˆÙ†,Ù…Ù„Ø§Ø­Ø¸Ø§Øª\n';
  for (var i = 0; i < db.length; i++) {
    var it = db[i];
    csv += it.name + ',' + it.qty + ',' + (it.gender || '') + ',' + (it.color || '') + ',"' + (it.note || '').replace(/"/g, '""') + '"\n';
  }
  var blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'backup_' + new Date().toISOString().slice(0, 10) + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  msg('âœ… Ù†Ø¬Ø­', 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

function exportMiss() {
  var m = [];
  for (var i = 0; i < db.length; i++) {
    if (db[i].qty === 0) m.push(db[i]);
  }
  if (m.length === 0) return msg('ğŸ‰ Ø±Ø§Ø¦Ø¹', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù†Ø§Ù‚ØµØ©!', 'success');
  var csv = 'Ø§Ù„Ø§Ø³Ù…,Ø§Ù„ÙƒÙ…ÙŠØ©,Ø§Ù„Ø¬Ù†Ø³,Ø§Ù„Ù„ÙˆÙ†,Ù…Ù„Ø§Ø­Ø¸Ø§Øª\n';
  for (var i = 0; i < m.length; i++) {
    var it = m[i];
    csv += it.name + ',' + it.qty + ',' + (it.gender || '') + ',' + (it.color || '') + ',"' + (it.note || '').replace(/"/g, '""') + '"\n';
  }
  var blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'missing_' + new Date().toISOString().slice(0, 10) + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  msg('âœ… Ù†Ø¬Ø­', 'ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

function openPrint() {
  document.getElementById('printModal').style.display = 'flex';
}

function closePrint() {
  document.getElementById('printModal').style.display = 'none';
}

function printRecords() {
  var g = document.querySelector('input[name="pg"]:checked').value;
  var t = document.querySelector('input[name="pt"]:checked').value;
  var items = [];
  for (var i = 0; i < db.length; i++) {
    var it = db[i];
    if (g !== 'all' && it.gender !== g) continue;
    if (t === 'zero' && it.qty !== 0) continue;
    if (t === 'one' && it.qty !== 1) continue;
    items.push(it);
  }
  if (items.length === 0) return msg('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©', 'warning');
  var title = t === 'zero' ? 'âŒ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©' : t === 'one' ? 'âš ï¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù†Ø§ÙØ°Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹ (ÙƒÙ…ÙŠØ©=1)' : 'ğŸ“‘ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª';
  if (g !== 'all') title += ' - ' + (g === 'Ø°ÙƒØ±' ? 'ğŸ‘¦ Ø°ÙƒÙˆØ±' : 'ğŸ‘§ Ø¥Ù†Ø§Ø«');
  var w = window.open('', '_blank');
  if (!w) return msg('âŒ Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©', 'error');
  var h = '<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>' + title + '</title>';
  h += '<style>';
  h += 'body{font-family:Arial,sans-serif;padding:30px;background:#f5f5f5}';
  h += '.print-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:30px;border-bottom:3px solid #4338ca;padding-bottom:20px}';
  h += '.logo-print{width:180px;height:auto;border-radius:12px}';
  h += '.header-info{flex:1;text-align:right;padding-right:30px}';
  h += 'h1{color:#4338ca;margin:0 0 15px 0;font-size:32px}';
  h += '.info{color:#666;font-size:15px;margin-bottom:8px}';
  h += 'table{width:100%;border-collapse:collapse;margin-top:30px;background:#fff;box-shadow:0 3px 15px rgba(0,0,0,0.1)}';
  h += 'th,td{border:2px solid #4338ca;padding:14px;text-align:center;font-size:15px}';
  h += 'th{background:#4338ca;color:#fff;font-weight:bold;font-size:16px}';
  h += '.z{background:#fee2e2;color:#991b1b;font-weight:bold}';
  h += '.o{background:#fef3c7;color:#92400e;font-weight:bold}';
  h += '.g{background:#d1fae5;color:#065f46}';
  h += '@media print{body{background:#fff}.no-print{display:none}}';
  h += '</style></head><body>';
  h += '<div class="print-header">';
  h += '<img src="https://i.postimg.cc/7ZrgS8qs/lwjw-bnfsjy-bsyt-%CA%BFn-stwdyw-3.png" class="logo-print" alt="Logo">';
  h += '<div class="header-info">';
  h += '<h1>' + title + '</h1>';
  h += '<div class="info">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ' + new Date().toLocaleDateString('ar-EG', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'}) + '</div>';
  h += '<div class="info">ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ' + items.length + '</div>';
  h += '</div>';
  h += '</div>';
  h += '<table><thead><tr>';
  h += '<th>#</th><th>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…</th><th>ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>âš§ï¸ Ø§Ù„Ø¬Ù†Ø³</th><th>ğŸ¨ Ø§Ù„Ù„ÙˆÙ†</th><th>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>';
  h += '</tr></thead><tbody>';
  for (var i = 0; i < items.length; i++) {
    var it = items[i];
    var c = it.qty === 0 ? 'z' : it.qty === 1 ? 'o' : 'g';
    var gIcon = it.gender === 'Ø°ÙƒØ±' ? 'ğŸ‘¦' : 'ğŸ‘§';
    h += '<tr>';
    h += '<td>' + (i + 1) + '</td>';
    h += '<td><strong>' + it.name + '</strong></td>';
    h += '<td class="' + c + '">' + it.qty + '</td>';
    h += '<td>' + gIcon + ' ' + (it.gender || '-') + '</td>';
    h += '<td>' + (it.color || '-') + '</td>';
    h += '<td>' + (it.note || '-') + '</td>';
    h += '</tr>';
  }
  h += '</tbody></table>';
  h += '<script>window.onload=function(){setTimeout(function(){window.print()},800)}<\/script>';
  h += '</body></html>';
  w.document.open();
  w.document.write(h);
  w.document.close();
  closePrint();
}

function restore() {
  document.getElementById('file').click();
}

document.getElementById('file').addEventListener('change', function(e) {
  var f = e.target.files[0];
  if (!f) return;
  if (!f.name.toLowerCase().endsWith('.csv')) {
    msg('âŒ Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù CSV ÙÙ‚Ø·', 'error');
    e.target.value = '';
    return;
  }
  var reader = new FileReader();
  reader.onload = function(ev) {
    try {
      var text = ev.target.result;
      var lines = text.split('\n');
      if (lines.length < 2) {
        msg('âŒ Ø®Ø·Ø£', 'Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        return;
      }
      var imported = [];
      for (var i = 1; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;
        var parts = [];
        var inQuotes = false;
        var current = '';
        for (var j = 0; j < line.length; j++) {
          var char = line[j];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            parts.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        parts.push(current);
        if (parts.length >= 5) {
          imported.push({
            name: parts[0].trim(),
            qty: parseInt(parts[1]) || 0,
            gender: parts[2].trim(),
            color: parts[3].trim(),
            note: parts[4].replace(/^"|"$/g, '').trim()
          });
        }
      }
      if (imported.length === 0) {
        msg('âŒ Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù', 'error');
        return;
      }
      if (confirm('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ' + imported.length + ' Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù…Ù„Ù\n\nâš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ\n\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©')) {
        db = imported;
        save();
        showAll();
        msg('âœ… Ù†Ø¬Ø­', 'ØªÙ… Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!<br><br>ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ' + imported.length + ' Ø³Ø¬Ù„', 'success');
      }
    } catch (err) {
      console.error('Ø®Ø·Ø£:', err);
      msg('âŒ Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© CSV ØµØ­ÙŠØ­Ø©', 'error');
    }
  };
  reader.readAsText(f, 'UTF-8');
  e.target.value = '';
});

init();
</script>
</body>
</html>
